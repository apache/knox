# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements. See the NOTICE file distributed with this
# work for additional information regarding copyright ownership. The ASF
# licenses this file to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# <p>
# http://www.apache.org/licenses/LICENSE-2.0
# <p>
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.

services:
  knox-dev:
    build:
      context: ../build
      dockerfile: Dockerfile
    image: apache/knox-dev:master

  knox-dev-local:
    build: &build_local
      context: ../build
      dockerfile: Dockerfile.local
      args:
        knoxurl: ${knoxurl:-https://github.com/apache/knox.git}
        branch: ${branch:-master}
    image: apache/knox-dev:local

  ldap:
    build: *build_local # Build LDAP service if not already built
    image: apache/knox-dev:local
    command: /ldap.sh

  knox:
    build: *build_local # Build Knox service if not already built
    image: apache/knox-dev:local
    command: /gateway.sh
    volumes:
#      - ./topologies:/knox-runtime/conf/topologies
      - ./logs:/knox-runtime/logs
#      - ./knoxshell:/knoxshell
    depends_on:
      - ldap

  tests:
    image: python:3.9-slim
    working_dir: /tests
    volumes:
      - ../tests:/tests
    environment:
      - KNOX_GATEWAY_URL=https://knox:8443/
    command: >
      bash -c "pip install -r requirements.txt 
      && echo 'Waiting for knox...' 
      && sleep 30 
      && pytest --junitxml=test-results.xml"
    depends_on:
      - knox


